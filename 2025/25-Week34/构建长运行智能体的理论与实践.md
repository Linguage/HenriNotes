构建长运行智能体的理论与实践

  

**概述**

  

本文由 Cognition 的 Walden Yan 撰写，核心论题是：当前多智能体（multi-agent）架构在实际应用中存在诸多问题，尤其在长时间运行和复杂任务中容易导致错误累积和决策冲突。作者提出了“上下文工程”（Context Engineering）作为智能体开发的关键原则，强调共享完整上下文和理解每个行动背后的隐含决策，主张以单线程线性智能体为主，并探讨了更高效的上下文管理方法。结论是：在现阶段，单智能体架构更可靠，多智能体协作尚未成熟，未来发展需持续关注上下文传递与决策一致性。

  

**智能体开发的背景与原则**

- 智能体开发尚处于早期阶段，类似于网页开发刚有 HTML 时的混沌状态。虽然有许多基础资源和框架，但缺乏像 React 之于前端开发那样的“哲学级”标准。
- 当前主流的多智能体架构（如 OpenAI Swarm、Microsoft Autogen）在实际生产环境中表现不佳，作者认为其核心问题在于上下文传递和决策一致性。
- 智能体开发的两大原则：

1. **共享上下文**：所有子智能体必须获得完整的任务背景和前序智能体的决策轨迹（agent trace），而不仅仅是单条消息。
2. **行动隐含决策**：每个行动都包含隐含决策，若各智能体的决策冲突，最终结果必然不理想。

- 以“开发 Flappy Bird 克隆”为例，若任务被拆分为“制作背景”和“制作小鸟”，但子智能体未能共享完整上下文，最终合成的游戏会出现风格不一致、功能不匹配等问题。这种情况在实际复杂任务中极为常见。
- 解决方案并非简单地将原始任务文本复制给所有子智能体，因为实际生产系统往往是多轮对话，涉及工具调用和多层细节，单靠文本无法保证一致性。

  

**长运行智能体的架构与上下文工程**

- 长时间运行的智能体面临的最大挑战是可靠性，尤其是在多轮对话和复杂任务拆解时，错误容易累积。
- “上下文工程”是智能体开发的核心工作，远超“提示工程”（Prompt Engineering）。它要求系统能自动、动态地为智能体提供最关键的任务背景和决策信息。
- 传统多智能体架构的缺陷在于：子智能体之间无法充分共享上下文，导致各自做出冲突决策，最终合成结果不可用。
- 最简单且有效的架构是单线程线性智能体：所有决策和行动都在同一上下文中连续进行，极大减少误解和冲突。
- 对于超大任务，单线程架构可能因上下文窗口溢出而受限。此时可引入专门的 LLM 模型，将历史行动和对话压缩为关键细节和决策。这一方法难度较高，需要针对具体领域进行模型微调，但能显著提升智能体处理长上下文的能力。
- 作者建议持续探索更优的上下文管理方法，认为这是智能体开发的深层挑战。

  

**真实案例分析与多智能体架构的局限**

- **Claude Code** **子智能体**：2025 年的 Claude Code 智能体会生成子任务，但不会与主智能体并行工作，且子智能体仅用于回答问题而非编写代码。原因在于子智能体缺乏主智能体的完整上下文，无法胜任复杂任务。并行子智能体容易产生冲突，降低系统可靠性。设计者选择了简单架构以保证稳定性。
- **Edit Apply** **模型**：2024 年，许多代码编辑模型表现不佳。主流做法是让大模型输出 Markdown 格式的编辑说明，再由小模型根据说明重写文件。但由于说明存在歧义，小模型常常误解指令，导致错误编辑。如今，编辑和应用操作多由单一模型一次性完成，减少了错误发生。
- **多智能体并行协作**：理论上，多个智能体可以通过“对话”解决冲突，类似人类工程师合并代码时的沟通。但目前智能体尚不具备高效、可靠的长上下文协作能力。多智能体系统决策分散，无法充分共享关键上下文，导致系统脆弱。作者认为，随着单智能体与人类沟通能力提升，未来多智能体协作的瓶颈会自然突破，届时并行与效率将大幅提升。

  

**框架与心智模型（****Framework & Mindset****）**

- **上下文工程框架**：

- 所有智能体行动必须基于完整的任务背景和前序决策轨迹。
- 避免并行多智能体架构，优先采用单线程线性智能体，确保决策一致性。
- 对于超长任务，采用专门模型压缩历史上下文，提取关键决策和事件。
- 在架构设计时，权衡上下文窗口限制与系统复杂度，选择最适合目标可靠性的方案。

- **心智模型**：

- 智能体开发者需时刻关注上下文传递和决策一致性，避免因信息不对称导致系统脆弱。
- 多智能体协作的理想状态是“所有行动都能看到其他所有行动”，但现实中需根据技术限制做出权衡。
- 未来智能体发展需保持开放心态，持续迭代框架和方法，灵活应对新挑战。

  

**基本信息**

- Title: Don’t Build Multi-Agents
- Author: Walden Yan
- Date: 2025-06-12
- URL: https://cognition.ai/blog/dont-build-multi-agents
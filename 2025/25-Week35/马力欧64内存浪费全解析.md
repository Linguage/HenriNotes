马力欧64内存浪费全解析

  

**概述**

  

本视频深入剖析了《超级马力欧64》（Super Mario 64）在任天堂64（Nintendo 64）主机上对4MB内存的使用情况，揭示了游戏在内存分配、管理和优化上的诸多浪费现象。作者不仅详细分析了各个内存区域的分布和用途，还通过对比、假设和实际测试，指出了许多可以节省内存的改进方法。结论是：虽然开发团队已经做了不少优化，但由于历史局限、开发习惯和一些低级失误，游戏实际浪费了大量宝贵的内存空间。通过一系列技术手段，理论上甚至可以让马力欧64运行在内存更小的PlayStation 1主机上。

  

**N64****内存结构与马力欧****64****的分配现状**

- 1996年，N64主机仅有4MB内存（约等于现代智能手机一张照片的大小），但需要同时容纳游戏代码、引擎、音乐、输出缓冲区和临时对象状态等多种数据。
- 在某些关卡（如开场地图），内存极度紧张，增加两张32x64像素的贴图就会导致内存溢出。
- 开发者不得不采用各种技巧和牺牲来“塞进”所有数据，比如压缩、复用、删减细节等。
- 马力欧64的内存分布大致如下：

- 1KB异常向量和配置
- 约1/3MB用于Z缓冲区（Zbuffer，深度缓存）
- 1.5MB为“内存池”，存放关卡和角色数据
- 0.5MB音乐数据
- 1MB代码
- 0.25MB变量和角色状态
- 0.125MB引擎代码
- 0.5MB帧输出缓冲区

- 所有4MB都被“刚好”用满，但实际上存在大量浪费和低效分配。

  

**主要内存浪费与优化可能**

  

**1.** **手动分配导致的空洞**

- 程序员手动指定各内存段的起止地址，导致段与段之间出现大量“空洞”——这些空间完全未被利用。
- 例如，帧缓冲区后有910字节空白，音乐区有113字节空白，Z缓冲区后有36800字节空白（约73张贴图的空间）。
- 这些空洞往往是计算失误或预留扩展空间造成的，实际开发中并未被填满。

  

**2.** **代码与引擎区的冗余**

- 游戏代码和引擎部分并未针对体积进行优化，甚至是以“调试模式”编译，包含大量无用注释、重复代码和调试信息。
- 仅将代码编译为“体积最小”模式即可节省约50%空间。
- 引擎区有一半内容仅在关卡加载时用到，之后就闲置在内存中，完全可以在用完后释放。
- 许多行为脚本、骨骼数据等也存在重复和冗余。

  

**3.** **角色状态与对象池的浪费**

- 每个角色（actor）无论复杂与否，都分配了固定的0x260字节（608字节）空间，哪怕只是静止的地形块或无功能的隐形对象。
- 其中约一半空间（0x140字节）对大多数对象来说是多余的，导致整体浪费巨大。
- 对象池固定为240个对象，但实际关卡最多只用到180个左右，多余的空间长期闲置。
- 这些设计让“刷怪”类的玩法成为可能，但对普通流程来说是浪费。

  

**4.** **音乐与音效系统的低效**

- 音乐数据采用“采样DMA缓冲区”机制，理论上可以动态复用，但实际实现中缓冲区并未被有效复用，导致2/3空间闲置。
- 通过代码检测发现，音乐区有18%空间始终为零，完全未被使用。
- 许多乐器采样、音符数据被一次性全部加载，实际只用到一小部分。

  

**5.** **贴图与几何数据的冗余**

- 贴图经常被分配全彩通道（RGBA），即使实际只需灰度，导致一半空间浪费。
- 关卡内所有子区域的数据会被一次性加载，即使玩家只会进入其中一部分。
- 一些碰撞、骨骼等数据在加载后就再也不会用到，却一直占据内存。

  

**6.** **缓冲区与****Z****缓冲区的边缘浪费**

- 屏幕上下的黑边始终被渲染并分配内存，但实际并不显示内容。
- Z缓冲区底部8行像素永远为黑色，也可以省略不分配。

  

**框架与心智模型（****Framework & Mindset****）**

- **内存分配的“建筑师****-****工人”模型**：程序员像建筑师，手动规划每一块内存的用途和位置；编译器像工人，按指令分配空间。手动分配虽灵活，但极易出错和浪费。现代做法更倾向于让编译器自动连续分配，减少空洞和维护成本。
- **“****只加载所需”原则**：如《塞尔达传说：时之笛》（Ocarina of Time）采用“overlay”机制，按需加载角色和关卡数据，极大节省内存。马力欧64则一次性加载全部，导致80%空间长期闲置。
- **“****功能与性能权衡”**：有些浪费是为了开发便利或兼容性（如对象池预留、调试代码保留），在开发周期和性能之间做出权衡。
- **“****优化的边界”**：只要游戏能正常运行且没有明显瓶颈，进一步优化内存意义有限。开发者往往会选择“够用就好”，而不是极致压榨。
- **“****历史局限与进步”**：后续游戏（如时之笛）在内存管理上有显著进步，采用更智能的分配和加载策略，体现了技术和经验的积累。

  

**基本信息**

- Title: Mario 64 wastes SO MUCH MEMORY
- Author: Kaze Emanuar
- Date: 2025-08-23
- URL: https://www.youtube.com/watch?v=oZcbgNdWL7w